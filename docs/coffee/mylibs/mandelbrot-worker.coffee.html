<!DOCTYPE html><html><head><title>mandelbrot-worker.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../index.html" class="source"><span class="file_name">README</span></a><a href="../../coffee/mylibs/color-converter.coffee.html" class="source "><span class="base_path">coffee / mylibs / </span><span class="file_name">color-converter.coffee</span></a><a href="../../coffee/mylibs/mandelbrot-worker.coffee.html" class="source selected"><span class="base_path">coffee / mylibs / </span><span class="file_name">mandelbrot-worker.coffee</span></a><a href="../../coffee/mylibs/mandelbrot.coffee.html" class="source "><span class="base_path">coffee / mylibs / </span><span class="file_name">mandelbrot.coffee</span></a><a href="../../coffee/script.coffee.html" class="source "><span class="base_path">coffee / </span><span class="file_name">script.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>mandelbrot-worker.coffee</h1><div class="filepath">coffee/mylibs/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre><span class="k">this</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="s">&#39;message&#39;</span><span class="p">,</span>
  <span class="p">(</span><span class="nf">(e) -&gt;</span>
    <span class="nv">data = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span>
    <span class="nv">escapeTimes = </span><span class="nx">getEscapeTimes</span> <span class="nx">data</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">box</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">maxIterations</span>
    <span class="nv">message = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span>
      <span class="nx">message</span><span class="o">:</span><span class="s">&quot;success&quot;</span>
      <span class="nx">value</span><span class="o">:</span><span class="nx">escapeTimes</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">postMessage</span> <span class="nx">message</span><span class="p">),</span>
  <span class="kc">false</span>

<span class="nv">getEscapeTimes = </span><span class="nf">(width, height, box, maxIterations) -&gt;</span>
  <span class="nv">self = </span><span class="k">this</span>
  <span class="nv">escapeTimes = </span><span class="p">[]</span>
  <span class="k">for</span> <span class="nx">row</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="nx">height</span><span class="p">]</span>
      <span class="nx">do</span> <span class="nf">(row) -&gt;</span>
        <span class="nv">rowTimes = </span><span class="p">[]</span>
        <span class="k">for</span> <span class="nx">column</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="nx">width</span><span class="p">]</span>
          <span class="nx">do</span> <span class="nf">(column) -&gt;</span>
            <span class="nv">real = </span><span class="nx">interpolate</span> <span class="nx">column</span><span class="p">,</span> <span class="nx">box</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nx">box</span><span class="p">.</span><span class="nx">right</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">width</span>
            <span class="nv">imaginary = </span><span class="nx">interpolate</span> <span class="nx">row</span><span class="p">,</span> <span class="nx">box</span><span class="p">.</span><span class="nx">top</span><span class="p">,</span> <span class="nx">box</span><span class="p">.</span><span class="nx">bottom</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">height</span>
            <span class="nx">rowTimes</span><span class="p">.</span><span class="nx">push</span> <span class="p">(</span><span class="nx">getEscapeTimeAtPoint</span> <span class="nx">real</span><span class="p">,</span> <span class="nx">imaginary</span><span class="p">,</span> <span class="nx">maxIterations</span><span class="p">)</span>
        <span class="nx">escapeTimes</span><span class="p">.</span><span class="nx">push</span> <span class="nx">rowTimes</span>
        <span class="nv">message = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span>
          <span class="nx">message</span><span class="o">:</span><span class="s">&quot;progress&quot;</span>
          <span class="nx">value</span><span class="o">:</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="nx">row</span><span class="o">/</span><span class="nx">height</span><span class="p">)</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">postMessage</span> <span class="nx">message</span>
  <span class="k">return</span> <span class="nx">escapeTimes</span>

<span class="nv">interpolate = </span><span class="nf">(x, y0, y1, x0, x1) -&gt;</span> <span class="nx">y0</span> <span class="o">+</span> <span class="p">(</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">x0</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="nx">y1</span> <span class="o">-</span> <span class="nx">y0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nx">x1</span><span class="o">-</span><span class="nx">x0</span><span class="p">))</span>

<span class="nv">getEscapeTimeAtPoint = </span><span class="nf">(real, imaginary, maxIteration) -&gt;</span>
  <span class="nv">x = </span><span class="mi">0</span>
  <span class="nv">y = </span><span class="mi">0</span>
  <span class="nv">iteration = </span><span class="mi">0</span>

  <span class="k">while</span> <span class="nx">x</span><span class="o">*</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span><span class="o">*</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="mi">2</span>  <span class="o">and</span>  <span class="nx">iteration</span> <span class="o">&lt;</span> <span class="nx">maxIteration</span>
    <span class="nv">xtemp = </span><span class="nx">x</span><span class="o">*</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">y</span><span class="o">*</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">real</span>
    <span class="nv">y = </span><span class="mi">2</span><span class="o">*</span><span class="nx">x</span><span class="o">*</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">imaginary</span>
    <span class="nv">x = </span><span class="nx">xtemp</span>
    <span class="nv">iteration = </span><span class="nx">iteration</span> <span class="o">+</span> <span class="mi">1</span>

  <span class="k">return</span> <span class="nx">iteration</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Sun Jun 17 2012 18:56:42 GMT+0100 (BST)  </div></div></body></html>