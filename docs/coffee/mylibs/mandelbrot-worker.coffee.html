<!DOCTYPE html><html><head><title>mandelbrot-worker.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../index.html" class="source"><span class="file_name">README</span></a><a href="../../coffee/mylibs/color-converter.coffee.html" class="source "><span class="base_path">coffee / mylibs / </span><span class="file_name">color-converter.coffee</span></a><a href="../../coffee/mylibs/mandelbrot-colors.coffee.html" class="source "><span class="base_path">coffee / mylibs / </span><span class="file_name">mandelbrot-colors.coffee</span></a><a href="../../coffee/mylibs/mandelbrot-core.coffee.html" class="source "><span class="base_path">coffee / mylibs / </span><span class="file_name">mandelbrot-core.coffee</span></a><a href="../../coffee/mylibs/mandelbrot-worker.coffee.html" class="source selected"><span class="base_path">coffee / mylibs / </span><span class="file_name">mandelbrot-worker.coffee</span></a><a href="../../coffee/mylibs/mandelbrot.coffee.html" class="source "><span class="base_path">coffee / mylibs / </span><span class="file_name">mandelbrot.coffee</span></a><a href="../../coffee/script.coffee.html" class="source "><span class="base_path">coffee / </span><span class="file_name">script.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>mandelbrot-worker.coffee</h1><div class="filepath">coffee/mylibs/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div><p>@licence This code is <a href="http://unlicense.org/UNLICENSE">unlicenced</a>.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>A web worker to evaluate the mandelbrot function for a set of pixels.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>We need MandelbrotCore to do the computations</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">self</span><span class="p">.</span><span class="nx">importScripts</span> <span class="s">&#39;../../js/mylibs/mandelbrot-core.js&#39;</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><h3>Messages</h3>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>Listener for messages from parent process</p>
</td><td class="code"><div class="highlight"><pre><span class="nv">listener = </span><span class="nf">(e) -&gt;</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>Callback to monitor progress</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">mandelbrot = </span><span class="k">new</span> <span class="nx">self</span><span class="p">.</span><span class="nx">MandelbrotCore</span> <span class="p">(</span><span class="nx">progress</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">message = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span>
      <span class="nx">message</span><span class="o">:</span><span class="s">&quot;progress&quot;</span>
      <span class="nx">value</span><span class="o">:</span><span class="nx">progress</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">postMessage</span> <span class="nx">message</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>Unpack data from call</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">data = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Calculate escape times</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">escapeTimes = </span><span class="nx">mandelbrot</span><span class="p">.</span><span class="nx">getEscapeTimes</span> <span class="nx">data</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">box</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">maxIterations</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>Build a message with the results</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">message = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span>
    <span class="nx">message</span><span class="o">:</span><span class="s">&quot;success&quot;</span>
    <span class="nx">value</span><span class="o">:</span><span class="nx">escapeTimes</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>Send the success message back to the parent</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">postMessage</span> <span class="nx">message</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>Add the listener to the message event, do not <code>useCapture</code></p>
</td><td class="code"><div class="highlight"><pre><span class="k">this</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="s">&#39;message&#39;</span><span class="p">,</span> <span class="nx">listener</span><span class="p">,</span> <span class="kc">false</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Fri Jun 22 2012 17:48:02 GMT+0100 (BST)  </div></div></body></html>